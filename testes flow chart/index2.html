<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistema De Flow Com PlumbJs Com Column</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        .menu {
            max-width: 25rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .containerTipo {
            width: 30rem;
        }

        .buttonAdicionarFromHome {
            color: #fff;
            margin-bottom: 1rem;
            background-color: #5870af;
            width: 19rem;
            font-size: 15pt;
        }

        .buttonAdicionarFromHome:hover {
            color: #fff;
            margin-bottom: 1rem;
            background-color: #5870af;
            width: 19rem;
        }

        .buttonSalvarFromHome {
            color: #fff;
            margin-bottom: 1rem;
            background-color: #5870af;
            width: 10rem;
            font-weight: bold;
        }

        .buttonSalvarFromHome:hover {
            color: #fff;
            margin-bottom: 1rem;
            background-color: #5870af;
            width: 10rem;
            font-weight: bold;
        }

        .buttonCancelarFromHome {
            color: #fff;
            margin-bottom: 1rem;
            background-color: gray;
            width: 10rem;
            font-weight: bold;
        }

        .buttonCancelarFromHome:hover {
            color: #fff;
            margin-bottom: 1rem;
            background-color: gray;
            width: 10rem;
            font-weight: bold;
        }

        .dropdownMargin {
            margin-bottom: -5rem !important;
            margin-left: 1rem !important;
        }

        .marginClasses-0 {
            margin-left: 2rem;
            margin-bottom: 1rem;
        }

        .marginClasses-1 {
            margin-left: 5rem;
            margin-bottom: 1rem;
        }

        .marginClasses-2 {
            margin-left: 10rem;
            margin-bottom: 1rem;
        }

        .marginClasses-3 {
            margin-left: 15rem;
            margin-bottom: 1rem;
        }

        .marginClasses-4 {
            margin-left: 20rem;
            margin-bottom: 1rem;
        }

        .marginClasses-5 {
            margin-left: 25rem;
            margin-bottom: 1rem;
        }

        .marginClasses-6 {
            margin-left: 30rem;
            margin-bottom: 1rem;
        }

        .marginClasses-7 {
            margin-left: 35rem;
            margin-bottom: 1rem;
        }

        .marginClasses-8 {
            margin-left: 40rem;
            margin-bottom: 1rem;
        }

        .marginClasses-9 {
            margin-left: 45rem;
            margin-bottom: 1rem;
        }

        .marginClasses-10 {
            margin-left: 50rem;
            margin-bottom: 1rem;
        }

        .marginClasses-11 {
            margin-left: 55rem;
        }

        .marginClasses-12 {
            margin-left: 60rem;
        }

        .buttonDeletarFromHome {
            color: #fff;
            margin-bottom: 1rem;
            background-color: red;
            width: 10rem;
            font-weight: bold;
        }

        .buttonDeletarFromHome:hover {
            color: #fff;
            margin-bottom: 1rem;
            background-color: red;
            width: 10rem;
            font-weight: bold;
        }
    </style>

</head>

<body class="overflow-x-hidden">

    <div class="container-fluid">
        <div class="row p-3">
            <!-- Linha do Primeiro Menu -->
            <div class="col-12 p-0" id="LinhaMenuPrincipal" style="margin-left: 2rem;">

            </div>
        </div>
    </div>

    <!--Modals-->
    <!--Modal Para Adição de Opção no Menu-->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-body">

                    <div class="d-flex gap-3 mt-3 justify-content-between">
                        <div class="containerTipo">
                            <label class="mb-2"><strong>Tipo</strong></label>
                            <!--Puxar Aqui Do Codigo Todos os Tipo Para Inserção-->
                            <select class="form-select" id="SelectTipo">
                                <option value="0" selected>Selecione um Tipo</option>
                                <option value="1">Redirecionamento</option>
                                <option value="2">Mensagem Simples</option>
                                <option value="3">Mensagem de Multipla Escolhas</option>
                            </select>
                        </div>

                        <div class="containerTipo" style="display: none;" id="DepartamentoSelect">
                            <label class="mb-2"><strong>Departamento destinado ao Redirecionamento</strong></label>
                            <!--Puxar Aqui Do Codigo Todos os Departamentos Para Inserção-->
                            <!--Lembrar que id vai ser o id do departamento selecionado em questao-->
                            <select id="selectDepartamento" class="form-select">
                                <option selected>Selecione um Departamento</option>
                                <option id="1" value="1">Suporte</option>
                                <option id="2" value="2">Financeiro</option>
                                <option id="3" value="3">Técnico</option>
                            </select>
                        </div>

                    </div>

                    <div class="gap-3 justify-content-between mt-4" style="display: none;"
                        id="FinalizarAtendimentoSelect">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="FinalizarChecked">
                            <label class="form-check-label" for="flexCheckDefault">
                                Finalizar atendimento ápos a resposta?
                            </label>
                        </div>
                    </div>

                    <!--Caso A mensagem Seja do Tipo de Resposta Simples-->
                    <div class="gap-3 justify-content-between mt-4 flex-column" style="display: none;"
                        id="TextareaSelect">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="mb-2"><strong>Titulo</strong></label>
                                <input id="TituloSimplesInput" placeholder="Obrigatorio" class="form-control" />
                            </div>
                            <div class="col-6 mb-3">
                                <label class="mb-2"><strong>Descricao</strong></label>
                                <input id="DescricaoSimplesInput" placeholder="Obrigatorio" class="form-control" />
                            </div>
                        </div>
                        <div class="w-100">
                            <label class="mb-2"><strong>Resposta</strong></label>
                            <textarea style="min-height: 10rem; resize: none;" id="textAreaContent"
                                class="form-control"></textarea>
                        </div>
                    </div>

                    <!--Caso A mensagem Seja do Tipo de Multiplas Escolhas-->
                    <div class="row mt-4" style="display: none;" id="MultiplaEscolha">
                        <div class="col-6 mb-3">
                            <label class="mb-2"><strong>Titulo da Opção</strong></label>
                            <input id="TituloOpcaoMenuInput" placeholder="Obrigatorio" class="form-control" />
                        </div>
                        <div class="col-6 mb-3">
                            <label class="mb-2"><strong>Descrição</strong></label>
                            <input id="DescricaoMenuInput" placeholder="Opcional" class="form-control" />
                        </div>
                        <div class="col-6 mb-3">
                            <label class="mb-2"><strong>Titulo do Menu</strong></label>
                            <input id="TituloMenuInput" placeholder="Obrigatorio" class="form-control" />
                        </div>
                        <div class="col-6 mb-3">
                            <label class="mb-2"><strong>Cabeçalho</strong></label>
                            <input id="cabecalhoMenuInput" placeholder="Opcional" class="form-control" />
                        </div>
                        <div class="col-6 mb-3">
                            <label class="mb-2"><strong>Corpo</strong></label>
                            <input id="corpoMenuInput" placeholder="Obrigatorio" class="form-control" />
                        </div>
                        <div class="col-6 mb-3">
                            <label class="mb-2"><strong>rodapé</strong></label>
                            <input id="rodapeMenuInput" placeholder="Opcional" class="form-control" />
                        </div>
                    </div>


                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn buttonCancelarFromHome" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn buttonSalvarFromHome" onclick="AdicionarEmDados()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!--Modal Para Exclusão de Opção no Menu-->
    <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="d-flex gap-3 mt-3 justify-content-between">
                        <h6 class="h6" id="ExclusaoHeader"><strong>Você Realmente Deseja a Exclusão do Item: ${Inserir o
                                Nome Dinamicamente Aqui}?</strong></h6>
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn buttonCancelarFromHome" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn buttonDeletarFromHome">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="./dados.js"></script>
    <script>

        var optionsCounter = 0
        var MenuCounter = 0
        var loopsCount = 0

        document.querySelector("#SelectTipo").addEventListener("change", (element) => {

            if (element.target.value == "0") {
                document.querySelector('#DepartamentoSelect').style.display = "none"
                document.querySelector("#FinalizarAtendimentoSelect").style.display = "none"
                document.querySelector("#TextareaSelect").style.display = "none"
                document.querySelector('#MultiplaEscolha').style.display = "none"
            }

            if (element.target.value == "1") {
                document.querySelector('#DepartamentoSelect').style.display = "block"
                document.querySelector("#FinalizarAtendimentoSelect").style.display = "none"
                document.querySelector("#TextareaSelect").style.display = "Flex"
            }

            if (element.target.value == "2") {
                document.querySelector("#FinalizarAtendimentoSelect").style.display = "Flex"
                document.querySelector("#TextareaSelect").style.display = "Flex"
                document.querySelector('#DepartamentoSelect').style.display = "none"
            }

            if (element.target.value == "3") {
                document.querySelector('#MultiplaEscolha').style.display = "Flex"
                document.querySelector('#DepartamentoSelect').style.display = "none"
                document.querySelector("#FinalizarAtendimentoSelect").style.display = "none"
                document.querySelector("#TextareaSelect").style.display = "none"
            }

        });

        function setMenId(menId) {
            localStorage.setItem("MenId", menId)
        }

        // Funções para simular o backend enquanto não integra com a página principal
        const getMenuPorId = (codigo) => data.filter(x => x.codigo == codigo)[0];
        const getMenuPorTipo = (Tipo) => data.filter(x => x.tipo == Tipo)[0];

        // Função para gerar o HTML dos menus em cascata
        const gerarMenuHtml = (menu, nivel = 0) => {
            MenuCounter = MenuCounter + 20
            let marginClass = `marginClasses-${nivel}`;
            let menuHtml = `
                <div class="col-12 p-0 mt-4 ${marginClass}">
                    <div class="bg-light p-4 rounded-0 border border-dark border-2 menu" id="Menu${menu.codigo}">
                        <strong class="h6 text-dark">${menu.titulo}</strong>
                        <div class="dropdown">
                            <button class="btn text-dark border-0" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" class="bi bi-arrow-right-circle" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5z"/>
                                </svg>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-start dropdownMargin" aria-labelledby="dropdownMenuButton">
                                <li><a data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="setMenId(${menu.codigo})" class="dropdown-item" href="#">Adicionar Opção</a></li>
                                <li><a class="dropdown-item" href="#">Atualizar Opção</a></li>
                                <li><a data-bs-toggle="modal" data-bs-target="#exampleModal2" class="dropdown-item border-top-5 border-dark" href="#">Excluir</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;

            menu.options.forEach((option) => {
                optionsCounter = optionsCounter + 10
                //<strong class="h6 text-dark">sou uma option de ${menu.titulo} | ${option.titulo}</strong>
                var optionNivel = nivel + 1;
                let optionMarginClass = `marginClasses-${optionNivel}`;

                let TipoACriacao = ``
                if (option.tipo == "MensagemDeRespostaInterativa" || option.tipo == "MensagemPorIA") {
                    TipoACriacao = `<li><a data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="setMenId(${option.resposta})" class="dropdown-item" href="#">Adicionar Opção</a></li>`
                }
                else {
                    TipoACriacao = `<li><a data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="setMenId(${option.codigoMenu})" class="dropdown-item" href="#">Adicionar Opção</a></li>`
                }
                

                menuHtml += `
                <div class="col-12 p-0 mt-4 ${optionMarginClass}">
                    <div class="bg-light p-4 rounded-0 border border-dark border-2 menu" id="option${option.codigo}">
                        
                        <strong class="h6 text-dark">${option.titulo}</strong>
                        <div class="dropdown">
                            <button class="btn text-dark border-0" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" class="bi bi-arrow-right-circle" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5z"/>
                                </svg>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-start dropdownMargin" aria-labelledby="dropdownMenuButton">
                                ${TipoACriacao}
                                <li><a class="dropdown-item" href="#">Atualizar Opção</a></li>
                                <li><a data-bs-toggle="modal" data-bs-target="#exampleModal2" class="dropdown-item border-top-5 border-dark" href="#">Excluir</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                `;

                // Se a opção tiver um submenu, gera o HTML recursivamente
                if (option.tipo == "MensagemDeRespostaInterativa" || option.tipo == "MensagemPorIA") {
                    const subMenu = getMenuPorId(parseInt(option.resposta));
                    if (subMenu) {
                        menuHtml += gerarMenuHtml(subMenu, optionNivel + 1);
                    }
                }
            });

            return menuHtml;
        };


        function Iniciar() {
            console.log("Carregou")
            console.log(data)
            const MenuInicial = getMenuPorTipo("PrimeiraMensagem");
            const menuHtml = gerarMenuHtml(MenuInicial);    
            document.querySelector("#LinhaMenuPrincipal").innerHTML = ` <div class="col-12 p-0">
                    <button class="btn buttonAdicionarFromHome" id="CreateMenu"><strong>Adicionar Menu</strong></button>
                </div>
                ` + menuHtml;
            const conectarMenus = (menu) => {
                menu.options.forEach(option => {

                    jsPlumb.connect({
                        source: `Menu${option.codigoMenu}`,
                        target: `option${option.codigo}`,
                        anchors: ["BottomLeft", "Left"],
                        connector: ["Flowchart"],
                        paintStyle: { stroke: "#000", strokeWidth: 2 },
                        endpoint: "Blank",
                        overlays: [
                            ["Arrow", { width: 1, length: 1, location: 1 }]
                        ]
                    });

                    if (loopsCount == 0) {
                        jsPlumb.connect({
                            source: `CreateMenu`,
                            target: `Menu${getMenuPorTipo("PrimeiraMensagem").codigo}`.trim(),
                            anchors: ["BottomLeft", "Left"],
                            connector: ["Flowchart"],
                            paintStyle: { stroke: "#000", strokeWidth: 2 },
                            endpoint: "Blank",
                            overlays: [
                                ["Arrow", { width: 1, length: 1, location: 1 }]
                            ]
                        });
                        loopsCount = loopsCount + 1
                    }

                    if (option.tipo == "MensagemDeRespostaInterativa" || option.tipo == "MensagemPorIA") {
                        jsPlumb.connect({
                            source: `option${option.codigo}`,
                            target: `Menu${option.resposta}`,
                            anchors: ["BottomLeft", "Left"],
                            connector: ["Flowchart"],
                            paintStyle: { stroke: "#000", strokeWidth: 2 },
                            endpoint: "Blank",
                            overlays: [
                                ["Arrow", { width: 1, length: 1, location: 1 }]
                            ]
                        });
                    }

                });
            };
            data.forEach(element => {
                conectarMenus(element);
            });
        }

        jsPlumb.ready(function () {
            Iniciar()
        });

        function AdicionarEmDados() {
            var selectValue = document.querySelector("#SelectTipo").value
            //Lembrar que como os id e 1,1 ele vao se preencher suave nao precisa ficar com dor de cabeca sobre isso

            if (selectValue == "1") {
                const newOption = {
                    "codigo": optionsCounter,
                    "codigoMenu": parseInt(localStorage.getItem("MenId")),
                    "titulo": document.querySelector("#TituloSimplesInput").value,
                    "descricao": document.querySelector("#DescricaoSimplesInput").value,
                    "resposta": document.querySelector("#selectDepartamento").id,
                    "tipo": "RedirecinamentoHumano",
                    "finalizar": document.querySelector("#FinalizarChecked").checked
                }

                getMenuPorId(parseInt(localStorage.getItem("MenId"))).options.push(newOption)
                Iniciar()
            }

            if (selectValue == "2") {
                const newOption = {
                    "codigo": optionsCounter,
                    "codigoMenu": parseInt(localStorage.getItem("MenId")),
                    "titulo": document.querySelector("#TituloSimplesInput").value,
                    "descricao": document.querySelector("#DescricaoSimplesInput").value,
                    "resposta": document.querySelector("#textAreaContent").value,
                    "tipo": "MensagemDeResposta",
                    "finalizar": document.querySelector("#FinalizarChecked").checked
                }
                Iniciar()
            }

            if (selectValue == "3") {

                const NewMenu = {
                    "codigo": MenuCounter,
                    "titulo": document.querySelector("#TituloMenuInput").value,
                    "header": document.querySelector("#cabecalhoMenuInput").value,
                    "body": document.querySelector("#corpoMenuInput").value,
                    "footer": document.querySelector("#rodapeMenuInput").value,
                    "tipo": "MenuBot",
                    "login": {
                        "codigo": 1,
                        "codigoWhatsap": "557999411293",
                        "usuario": "Master",
                        "email": "master.123@123",
                        "senha": "c2VuYWkuMTIz",
                        "imagem": "img-placeholder",
                        "plano": "master"
                    },
                    "options": []
                }

                const newOption = {
                    "codigo": optionsCounter,
                    "codigoMenu": parseInt(localStorage.getItem("MenId")),
                    "titulo": document.querySelector("#TituloOpcaoMenuInput").value,
                    "descricao": document.querySelector("#DescricaoMenuInput").value,
                    "resposta": NewMenu.codigo.toString(),
                    "tipo": "MensagemDeRespostaInterativa",
                    "finalizar": document.querySelector("#FinalizarChecked").checked
                }

                data.push(NewMenu)
                getMenuPorId(localStorage.getItem("MenId")).options.push(newOption)
                Iniciar()
            }

        }

    </script>


</body>

</html>